<?xml version="1.0" encoding="utf-8"?>
<wizard:WizardWindow xmlns:fx="http://ns.adobe.com/mxml/2009" 
							  xmlns:s="library://ns.adobe.com/flex/spark"
							  title="Create Key Pair"
							  xmlns:mx="library://ns.adobe.com/flex/mx" 
							  xmlns:components="com.momentumsi.c9.components.*"
							  xmlns:services="com.momentumsi.c9.services.*"
							  xmlns:wizard="com.momentumsi.c9.components.wizard.*"
							  width="400" height="140">
	
	<fx:Script>
		<![CDATA[
			import mx.controls.Alert;
			import mx.managers.PopUpManager;
			import mx.rpc.events.FaultEvent;
			import mx.rpc.events.ResultEvent;
			
			[Bindable]
			private var keyPairCreated:Boolean = false;
			
			protected function createButton_clickHandler(event:MouseEvent):void
			{
				createButton.enabled = false;
				createButton.label = "Creating";
				ec2Service.createKeyPair(keyPairName.text);
				ec2Service.addEventListener(ResultEvent.RESULT, ec2Service_resultHandler);
				ec2Service.addEventListener(FaultEvent.FAULT, ec2Service_faultHandler);
			}
			
			protected function ec2Service_resultHandler(event:ResultEvent):void
			{
				ec2Service.removeEventListener(ResultEvent.RESULT, ec2Service_resultHandler);
				ec2Service.removeEventListener(FaultEvent.FAULT, ec2Service_faultHandler);
				keyPairCreated = true;
				keyForm.addElement(keyMaterialItem);
				keyMaterialTA.text = ec2Service.keyMaterial;
				width = width + 80;
				height = height + 300;
				PopUpManager.centerPopUp(this);
			}
			
			protected function ec2Service_faultHandler(event:FaultEvent):void
			{
				ec2Service.removeEventListener(ResultEvent.RESULT, ec2Service_resultHandler);
				ec2Service.removeEventListener(FaultEvent.FAULT, ec2Service_faultHandler);
				createButton.enabled = true;
				createButton.label = "Create";
			}
			
			protected function saveButton_clickHandler(event:MouseEvent):void
			{
				var file:FileReference = new FileReference();
				file.addEventListener(Event.COMPLETE, keyDownloaded);
				var fileName:String = keyPairName.text + ".pem";
				file.save(ec2Service.keyMaterial, fileName);
			}
			
			private function keyDownloaded(event:Event):void
			{
				PopUpManager.removePopUp(this);
			}
			
		]]>
	</fx:Script>
	
	<fx:Declarations>
		<!-- Place non-visual elements (e.g., services, value objects) here -->
		<services:Ec2Service id="ec2Service"
							 cloudAccountId="{cloudAccount.id}"
							 region="{region}"/>
		
		<s:FormItem id="keyMaterialItem" label="Key Material:">
			<s:TextArea id="keyMaterialTA"
						editable="false"
						width="325" height="280"/>
		</s:FormItem>
	</fx:Declarations>
	<s:VGroup id="group" width="100%">
		<s:Form id="keyForm">
			<s:FormItem label="Key Pair Name:">
				<s:TextInput id="keyPairName"/>
			</s:FormItem>
		</s:Form>
		<s:HGroup width="100%" horizontalAlign="center">
			<s:Button id="saveButton"
					  label="Save"
					  click="saveButton_clickHandler(event)"
					  visible="{keyPairCreated}"
					  includeInLayout="{keyPairCreated}"/>
			<s:Button id="createButton"
					  label="Create"
					  click="createButton_clickHandler(event)"
					  visible="{!keyPairCreated}"
					  includeInLayout="{!keyPairCreated}"/>
			<s:Button label="Cancel"
					  click="PopUpManager.removePopUp(this)"/>
		</s:HGroup>
	</s:VGroup>
</wizard:WizardWindow>
